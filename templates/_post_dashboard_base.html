<!-- templates/_post_dashboard_base.html -->
{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{% block title %}Bandcamp++{% endblock title %}</title>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
        <!-- CSS -->
        <link rel="stylesheet" href="{% static 'css/base.css' %}">
    </head>
    <body>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container-fluid">                
                <a class="navbar-brand" href="#">Bandcamp++</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
                    aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>                
            </div>
        </nav>

        <div class='progress-wrapper container-fluid'>  
            <div id='progress-bar' class='progress-bar' style="background-color: #68a9ef; width: 0%;">&nbsp;</div>
        </div>
        <div id="progress-bar-message">Waiting for progress to start...</div>

        <div id="celery-result"></div>
        
        <button type="button" id="testrun" disabled>test run</button>
        <button type="button" id="testabort" disabled>test abort</button>
        <input type="checkbox" id="10sec">
        <label for="10sec">+10 sec</label>
        <input type="checkbox" id="16sec">
        <label for="10sec">+16 sec</label>
        <input type="checkbox" id="23sec">
        <label for="10sec">+23 sec</label>

        <br/>
        {{ base_profile_obj.name }} | {{ base_profile_obj.username }}
        <image src="{{ base_profile_img_url }}">

        <div class="container" id="content">
        </div>

        <!-- Bootstrap JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        <!-- JavaScript -->
        <script src="{% static 'js/base.js' %}"></script>
    
        <script>
            let progressUrl = "{% url 'celery_progress:task_status' 'django-test-main' %}";
            
            let pollInterval = 1000;
            let runPressed = false;
            let abortPressed = false;
            console.log("preflight");
          
            function sleep(ms) {
              return new Promise(resolve => setTimeout(resolve, ms));
            };
          
            async function progressBar() {
          
              // init bar
              let progressBarElement = document.getElementById('progress-bar');
              let progressBarMessageElement = document.getElementById('progress-bar-message');
              let abortButton = document.getElementById("testabort");
              let runButton = document.getElementById("testrun");
          
              let barColors = {
                success: '#76ce60',
                error: '#dc4f63',
                progress: '#68a9ef',
                ignored: '#7a7a7a'
              }
              
          
              let messages = {
                waiting: 'Waiting for task to start...',
                started: 'Task started...',
              }    
          
              // event loop
              console.log("start event loop");
              
              let ProgressSocket = new WebSocket("ws://127.0.0.1:8001/ws/progress/django-test-main/")//"ws://" + window.location.host + progressUrl);
          
              ProgressSocket.onopen = function (event) {
                  ProgressSocket.send(JSON.stringify({'type': 'check_task_completion'}));
              };
          
              const bar = this;
              ProgressSocket.onmessage = function (event) {
                let data;
                try { data = JSON.parse(event.data); } 
                  catch (parsingError) { throw parsingError; }
                
                console.log(data);
          
                if (data.progress) {
                  progressBarElement.style.backgroundColor = barColors.progress;
                  progressBarElement.style.width = data.progress.percent + "%";
                  var description = data.progress.description || "";
                  if (data.progress.current == 0) {
                    if (data.progress.pending === true) {
                      if (!runPressed) {
                        runButton.disabled = false;
                        abortButton.disabled = true;
                      }
                      progressBarMessageElement.textContent = messages.waiting;
                    } else {
                      progressBarMessageElement.textContent = messages.started;
                      runButton.disabled = true;
                      abortButton.disabled = true;
                    }
                  } else {
                    if (abortPressed) {
                      runButton.disabled = false;
                      abortButton.disabled = true;              
                    } else {
                      runButton.disabled = true;
                      abortButton.disabled = false;
                      progressBarMessageElement.textContent = data.progress.current + ' of ' + data.progress.total + ' processed. ' + description;
                    }            
                  }
                };
                abortPressed = false;
                runPressed = false;
          
                if (data.complete === true) {  
                    console.log("COMPLETE?????");
                    runButton.disabled = false;
                    abortButton.disabled = true;
                    fetch("progtest/reset");
                    progressBarElement.style.width = "0%";
                    progressBarMessageElement.textContent = messages.waiting;
                    // TODO if not success??
                };
              };
            };         
                  
          
            function runfun() {
              document.getElementById("testrun").disabled = true;
              runPressed = true;
              console.log("runfun");
              fetch("progtest/run");
            };
            
            function abortfun() {
              document.getElementById("testabort").disabled = true;
              abortPressed = true;
              console.log("abortfun");
              fetch("progtest/abort");
            };

           async function init_dashboard_content() {
                fetch("{{ ajax_content_link }}")
                .then((response) => {
                    if (response.ok) { return response.text(); }
                })
                .then((html) => {
                    document.getElementById('content').innerHTML = html
                });
            };
          
            function init() {
              console.log("init");
              document.getElementById("testabort").addEventListener("click", abortfun);
              document.getElementById("testrun").addEventListener("click", runfun);
              progressBar();
              init_dashboard_content();
            };

          
            document.addEventListener("DOMContentLoaded", init);  
          </script>

        {% block codetail %}
        
        {% endblock codetail %}
    </body>
</html>